graph TB
    subgraph PHASE1["ğŸ“¥ PHASE 1: INPUT PREPARATION"]
        IN1["Interview Setup<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Role: Senior Frontend Developer<br/>â€¢ Level: Senior<br/>â€¢ Tech Stack: React, TypeScript<br/>â€¢ Type: AI Audio Interview<br/>â€¢ Question Count: 5"]
        
        IN2["Questions Source<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mode: Provided<br/>Questions:<br/>1. Tell me about yourself<br/>2. Why this role?<br/>3. Challenging project?<br/>4. Handle conflicts?<br/>5. Your strengths?"]
        
        IN3["Company Info<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Optional:<br/>â€¢ Company name<br/>â€¢ Culture<br/>â€¢ Benefits"]
        
        IN4["Vapi.ai Assistant Config<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Transcriber: Deepgram Nova-2<br/>â€¢ Voice: 11Labs Sarah<br/>â€¢ Model: GPT-4<br/>â€¢ System Prompt: Interviewer role"]
    end
    
    subgraph PHASE2["ğŸ¤ PHASE 2: REAL-TIME INTERVIEW"]
        RT1["Candidate Joins<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Enter access code<br/>â†’ Connect to Vapi.ai<br/>â†’ WebRTC established"]
        
        RT2["Voice Conversation Loop<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>1. AI asks question (11Labs TTS)<br/>2. Candidate answers (voice)<br/>3. Deepgram transcribes (STT)<br/>4. GPT-4 processes & responds<br/>5. Repeat for all questions"]
        
        RT3["Real-time Transcription<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>User: 'I have 5 years of experience...'<br/>AI: 'That's great! Can you tell me...'<br/>â†’ Saved as messages array"]
        
        RT4["Q&A Extraction<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Extract structured turns:<br/>[{<br/>  orderIndex: 1,<br/>  questionText: 'Tell me...',<br/>  answerText: 'I have...',<br/>  questionCategory: 'BEHAVIORAL'<br/>}]"]
    end
    
    subgraph PHASE3["ğŸ’¾ PHASE 3: DATA PERSISTENCE"]
        DB1["Save Interview Record<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ status: IN_PROGRESS<br/>â€¢ transcript: full text<br/>â€¢ applicationId: linked"]
        
        DB2["Save Interview Exchanges<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>For each Q&A pair:<br/>â€¢ InterviewExchange record<br/>â€¢ orderIndex<br/>â€¢ questionText<br/>â€¢ answerText<br/>â€¢ questionCategory"]
    end
    
    subgraph PHASE4["ğŸ“Š PHASE 4: AI EVALUATION"]
        EV1["Trigger Analysis<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>POST /interviews/:id/analyze<br/>Input:<br/>â€¢ Full transcript<br/>â€¢ Turns array<br/>â€¢ Seniority: SENIOR<br/>â€¢ Keywords: [React, TypeScript, ...]"]
        
        EV2{"Evaluation Mode<br/>Check ENV"}
        
        EV3["Mode: GEMINI<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>generateInterviewFeedbackWithGemini()"]
        
        EV4["Mode: RULE_BASED<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>generateInterviewFeedbackRuleBased()"]
        
        subgraph GEMINI_PROCESS["ğŸ§  Gemini Processing"]
            GP1["Build Analysis Prompt<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Include:<br/>â€¢ Full transcript<br/>â€¢ Structured Q&A<br/>â€¢ Evaluation criteria<br/>â€¢ Scoring weights"]
            
            GP2["Call Gemini 2.5 Flash<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Model: gemini-2.5-flash<br/>Input: Analysis prompt<br/>Output: Structured JSON"]
            
            GP3["Parse & Validate JSON<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Schema validation:<br/>â€¢ overallScore: 0-100<br/>â€¢ recommendation: HIRE/CONSIDER/REJECT<br/>â€¢ categoryScores: Array<br/>â€¢ perQuestion: Array"]
        end
        
        subgraph RULE_PROCESS["ğŸ“‹ Rule-based Processing"]
            RP1["Score Each Answer<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>6 Criteria:<br/>1. Length (count words)<br/>2. Structure (STAR detection)<br/>3. Examples (metrics detection)<br/>4. Confidence (filler words)<br/>5. Keyword Match<br/>6. Relevance (Jaccard)"]
            
            RP2["Calculate Weights<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Adjust by question type:<br/>â€¢ Technical: +keywordMatch<br/>â€¢ Behavioral: +structure<br/>â€¢ General: default"]
            
            RP3["Generate Feedback<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Overall score (avg Ã— 10)<br/>â€¢ Recommendation logic<br/>â€¢ Category scores<br/>â€¢ Per-question feedback"]
        end
    end
    
    subgraph PHASE5["âœ… PHASE 5: RESULTS & OUTPUT"]
        OUT1["Structured Feedback Object<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>{<br/>  overallScore: 85,<br/>  recommendation: 'HIRE',<br/>  summary: 'Strong candidate...',<br/>  strengths: ['Clear communication', ...],<br/>  areasForImprovement: [...],<br/>  categoryScores: [<br/>    {name: 'Clarity', score: 9, ...},<br/>    ...<br/>  ],<br/>  perQuestion: [<br/>    {orderIndex: 1, score: 8, feedback: '...'},<br/>    ...<br/>  ]<br/>}"]
        
        OUT2["Database Updates<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Interview.status = 'COMPLETED'<br/>â€¢ Interview.overallScore = 85<br/>â€¢ Interview.recommendation = 'HIRE'<br/>â€¢ Interview.summary = '...'<br/>â€¢ Interview.aiAnalysisData = {...}<br/>â€¢ InterviewExchange.score = 8 (per Q)"]
        
        OUT3["Application Status Update<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>If linked to application:<br/>â€¢ Application.status = 'INTERVIEWED'<br/>â€¢ ApplicationHistory record created"]
        
        OUT4["Email Notifications<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ To Recruiter:<br/>  Interview completed<br/>  Score: 85/100<br/>  Recommendation: HIRE<br/>â€¢ Link to view feedback"]
    end
    
    %% Flow connections
    IN1 --> RT1
    IN2 --> RT1
    IN3 --> RT1
    IN4 --> RT1
    
    RT1 --> RT2
    RT2 --> RT3
    RT3 --> RT4
    
    RT4 --> DB1
    RT4 --> DB2
    
    DB1 --> EV1
    DB2 --> EV1
    
    EV1 --> EV2
    EV2 -->|GEMINI| EV3
    EV2 -->|RULE_BASED| EV4
    
    EV3 --> GP1 --> GP2 --> GP3 --> OUT1
    EV4 --> RP1 --> RP2 --> RP3 --> OUT1
    
    OUT1 --> OUT2
    OUT2 --> OUT3
    OUT2 --> OUT4
    
    %% Styling
    classDef phase1 fill:#e3f2fd,stroke:#0277bd,stroke-width:3px,color:#000
    classDef phase2 fill:#fff3e0,stroke:#e65100,stroke-width:3px,color:#000
    classDef phase3 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    classDef phase4 fill:#e8f5e9,stroke:#1b5e20,stroke-width:3px,color:#000
    classDef gemini fill:#e1bee7,stroke:#4a148c,stroke-width:2px,color:#000
    classDef rule fill:#fffde7,stroke:#f57f17,stroke-width:2px,color:#000
    classDef phase5 fill:#c8e6c9,stroke:#1b5e20,stroke-width:3px,color:#000
    classDef decision fill:#fff9c4,stroke:#f9a825,stroke-width:2px,color:#000
    
    class IN1,IN2,IN3,IN4,PHASE1 phase1
    class RT1,RT2,RT3,RT4,PHASE2 phase2
    class DB1,DB2,PHASE3 phase3
    class EV1,EV3,EV4,PHASE4 phase4
    class GP1,GP2,GP3,GEMINI_PROCESS gemini
    class RP1,RP2,RP3,RULE_PROCESS rule
    class OUT1,OUT2,OUT3,OUT4,PHASE5 phase5
    class EV2 decision

